<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <!-- physics and other extras -->
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.13.1/dist/aframe-extras.min.js"></script>
    <!-- alternate random number generator -->
    <script src="js/random.js"></script>
    <!-- utility functions from the Tutorial https://hacks.mozilla.org/2018/03/immersive-aframe-low-poly/ -->
    <!-- particle systems -->
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.x/dist/aframe-particle-system-component.min.js"></script>
    <script>
      $ = sel => document.querySelector(sel);
      $$ = sel => document.querySelectorAll(sel);
      on = (elem, type, hand) => elem.addEventListener(type, hand);
    </script>

    <!-- HTTPS redirect -->
    <script>
      if (location.protocol !== "https:") {
        location.replace(
          `https:${location.href.substring(location.protocol.length)}`
        );
      }
    </script>

    <!-- Randomly scattered asteroids. Not working yet. -->
    <script>
      function rand(min, max) {
        return Math.random() * (max - min) + min;
      }
      AFRAME.registerComponent("distribute", {
        schema: {
          src: { type: "string" },
          jitter: { type: "vec3" },
          centerOffset: { type: "vec3" },
          radius: { type: "number" }
        },
        init: function() {
          const rg = new Random(Random.engines.mt19937().seed(10));
          const center = new THREE.Vector3(
            this.data.centerOffset.x,
            this.data.centerOffset.y,
            this.data.centerOffset.z
          );
          const jx = this.data.jitter.x;
          const jy = this.data.jitter.y;
          const jz = this.data.jitter.z;
          if ($(this.data.src).hasLoaded) {
            const s = this.data.radius;
            for (let i = -s; i < s; i++) {
              for (let j = -s; j < s; j++) {
                const el = document.createElement("a-entity");
                el.setAttribute("gltf-model", this.data.src);
                const offset = new THREE.Vector3(
                  i * s + rg.real(-jx, jx),
                  rg.real(-jy, jy),
                  j * s - rg.real(-jz, jz)
                );
                el.setAttribute("position", center.clone().add(offset));
                el.setAttribute("rotation", {
                  x: 0,
                  y: (rg.real(-45, 45) * Math.PI) / 180,
                  z: 0
                });
                const scale = rg.real(0.5, 1.5);
                el.setAttribute("scale", { x: scale, y: scale, z: scale });
                $("a-scene").appendChild(el);
              }
            }
          }
        }
      });
    </script>

    <!-- Flight -->
    <script type="text/javascript">
      AFRAME.registerComponent("listener", {
        schema: {
          stepFactor: {
            type: "number",
            default: 0.05
          }
        },
        tick: function() {
          this.el.components.camera.camera.parent.position.add(
            this.el.components.camera.camera
              .getWorldDirection()
              .multiplyScalar(this.data.stepFactor)
          );
        }
      });
    </script>
  </head>

  <!-- Asset List -->
  <body>
    <a-scene>
      <a-assets>
        <a-asset-item
          id="rock"
          src="https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2FRubbishAsteroid.glb?v=1634518101527"
        ></a-asset-item>
        <a-asset-item
          id="planet"
          src="https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2FPlanet.gltf?v=1634667469737"
        ></a-asset-item>
        <a-asset-item
          id="planet2o"
          src="https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2FTest_planet.obj?v=1634669432637"
        ></a-asset-item>
        <a-asset-item
          id="planet2m"
          src="https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2FTest_planet.mtl?v=1634669452429"
        ></a-asset-item>
        <a-asset-item
          id="ringo"
          src="https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2FTest_ring.obj?v=1634673464331"
        ></a-asset-item>
        <a-asset-item
          id="ringm"
          src="https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2FTest_Rings.png?v=1634673473137"
        ></a-asset-item>
      </a-assets>

      <!-- The Ship -->
      <a-entity id="rig" movement-controls="fly: true; speed: 0.1">
        <a-entity
          camera
          listener="stepFactor:0.01"
          position="0 1.6 10"
          look-controls
        >
          <a-cursor></a-cursor>
        </a-entity>
      </a-entity>

      <!-- The Environment -->

      <a-entity>
        <a-gltf-model
          src="#rock"
          position="0 0 0"
          scale=".5 .5 .5"
        ></a-gltf-model>
        <a-gltf-model
          position="-300 0 -200"
          scale="20 20 20"
          src="#planet"
          material="fog: false"
        ></a-gltf-model>
      </a-entity>

      <!-- Super laggy for some reason 
      <a-entity position="0 0 0" particle-system="preset: dust; texture: https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2FDustSpeck.png?v=1634660823690; color: #0000FF,#00FF00,#FF0000"></a-entity>
      -->

      <!-- Attempted Asteroid Field 
      <a-entity distribute="jitter: 2 0.5 2; centerOffset: 59 -0.8 32; src:"https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2FRubbishAsteroid.gltf?v=1634517502547"; radius:3"></a-entity>
      -->

      <!-- pretty sky, cause why not! -->
      <a-sky
        id="sky"
        rotation="0 180 0"
        src="https://cdn.glitch.me/e99f4064-e398-48d8-882b-d24a844fbb01%2Fpanorama_image.png?v=1634611197961"
      ></a-sky>

      <a-light
        type="directional"
        position="0 0 0"
        rotation="-90 0 0"
        target="#directionaltarget"
      >
        <a-entity id="directionaltarget" position="0 -1 0"></a-entity>  light="target:  [object HTMLElement];  intensity:  2.03"
      </a-light>
      <a-light type="ambient"></a-light>
    </a-scene>
  </body>
</html>
